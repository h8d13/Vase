#!/bin/bash
set -e

. "$(dirname "$0")/../../util_f"
. "$(dirname "$0")/../../..."

if file_ex "${rel}${p_lib}/${rcw_file}"; then
    # Source wrapper
    . "${rel}${p_lib}/${rcw_file}"
fi

SCRIPT_DIR="$(dirname "$0")"
PROFILE_DIR="$SCRIPT_DIR/archiso_profile"
WORK_DIR="$SCRIPT_DIR/archiso_work"
OUTPUT_DIR="$SCRIPT_DIR/a"

info "Setting up archiso profile..."
#rm -rf "$PROFILE_DIR"
mkdir -p "$PROFILE_DIR"
# Use standard release engeneering profile (same as ISO)
cp -r /usr/share/archiso/configs/releng/* "$PROFILE_DIR"

# Customize ISO name in profiledef.sh
sed -i 's/^iso_name=.*/iso_name="VASE"/' "$PROFILE_DIR/profiledef.sh"

info "Adding customizations to airootfs..."
## Note: We don't copy hade_box overlay - users will git clone instead
## This keeps the ISO smaller and ensures they always get latest code
mkdir -p "$PROFILE_DIR/airootfs/root"

# Append custom MOTD
build_date=$(date '+%Y.%m.%d')
cat >> "$PROFILE_DIR/airootfs/etc/motd" << EOF

╔═══════════════════════════════════════╗
      VASE ARCH INSTALLER v${vase_v}      
      Generated ${build_date} <3            
╚═══════════════════════════════════════╝
EOF

# Add Plasma packages + Git to ISO (toggle with ADD_PROFILE)
ADD_PROFILE="1"

if [ "$ADD_PROFILE" = "1" ]; then
    PROFILE_LIST="$SCRIPT_DIR/iso_profiles/plasma.conf"
    if file_ex "$PROFILE_LIST"; then
        info "Adding Plasma packages to ISO package list..."

        # Read packages from profile (skip comments and empty lines)
        packages=$(grep -v '^#' "$PROFILE_LIST" | grep -v '^$')

        if [ -n "$packages" ]; then
            # Append to ISO packages.x86_64
            echo "" >> "$PROFILE_DIR/packages.x86_64"
            echo "# Plasma Desktop packages from profile" >> "$PROFILE_DIR/packages.x86_64"
            echo "$packages" >> "$PROFILE_DIR/packages.x86_64"

            pkg_count=$(echo "$packages" | wc -l)
            reop "Added $pkg_count Plasma packages to ISO"
        fi
    else
        warn "No profile found at $PROFILE_LIST, skipping Plasma packages"
    fi
else
    info "ADD_PROFILE=0, skipping Plasma packages"
fi
## Intresting to note that xz compression manages to keep the ISO quite small (2,3gb with plasma packages)

info "Building ISO with mkarchiso..."
## Think of this as a temp file for intermediate building
mkdir -p "$WORK_DIR"

ISO_LABEL="VASE_$(date +%Y%m)"
mkarchiso -v -w "$WORK_DIR" -o "$OUTPUT_DIR" -L "$ISO_LABEL" "$PROFILE_DIR"
info "Cleaning up..."
rm -rf "$PROFILE_DIR"
rm -rf "$WORK_DIR"
chown_all "$SUDO_USER" "$OUTPUT_DIR" 

reop "Done! New ISO created in: $OUTPUT_DIR"
