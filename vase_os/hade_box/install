#!/bin/bash
set -e
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

. "$SCRIPT_DIR/../../util_f"
# Source constants if they exist
if file_ex "$SCRIPT_DIR/../../..."; then
    . "$SCRIPT_DIR/../../..."
fi

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo "Error: This script must be run as root"
    exit 1
fi
preop "HADE_BOOT - ARCHINSTALL"
# Determine if we running from ISO or not
if [ -d "/run/archiso" ]; then
    preop "Running from Arch Linux ISO / USB Medium"
    # Always check python modules even tho they should be in ISO
    PYTHON_MODULES=(
        "cryptography:python-cryptography"
        "parted:python-pyparted"
        "pydantic:python-pydantic"
    )
    for module_pkg in "${PYTHON_MODULES[@]}"; do
        module="${module_pkg%%:*}"
        package="${module_pkg##*:}"
        if python -c "import $module" 2>/dev/null; then
            version=$(pacman -Qi "$package" 2>/dev/null | grep "^Version" | awk '{print $3}')
            preop "Found: $package (${version:-unknown})"
        else
            postop "Missing: $package ($module)"
            MISSING+=("$package")
        fi
    done
    preop "Checked only python deps. Skipping full check..."

    # Check internet connectivity before proceeding
    preop "Checking internet connectivity..."
    if ping -c 3 google.com >/dev/null 2>&1; then
        preop "Internet connection verified"
    else
        postop "No internet connection detected!"
        echo ""
        echo "Please configure your network connection:"
        echo "  - Ethernet: Should work automatically"
        echo "  - WiFi: Use 'iwctl' to connect"
        echo "    Example: iwctl station wlan0 connect 'YourSSID'"
        echo ""
        exit 1
    fi
    # Arch disabled reflector.service auto-run - run it manually for fast mirrors
    # Skip if reflector already ran successfully (user restarted installer)
    current_mirrors="$(grep -c '^Server = ' /etc/pacman.d/mirrorlist 2>/dev/null || echo 0)"

    # Only skip reflector if:
    # 1. Original backup exists (reflector ran at least once)
    # 2. Current mirrorlist has reasonable number of filtered mirrors (10-30 range)
    # 3. Current mirrorlist is valid (can be parsed)
    if [ -f /etc/pacman.d/mirrorlist.original ] && [ "${current_mirrors}" -ge 10 ] 2>/dev/null && [ "${current_mirrors}" -le 50 ] 2>/dev/null; then
        # Verify current mirrorlist is actually valid by checking it has content
        if grep -q '^Server = ' /etc/pacman.d/mirrorlist 2>/dev/null; then
            preop "Reflector already ran ($current_mirrors mirrors), skipping..."
        else
            # Mirrorlist exists but is corrupted, restore from backup and run reflector
            postop "Mirrorlist corrupted, restoring from backup..."
            cp /etc/pacman.d/mirrorlist.original /etc/pacman.d/mirrorlist 2>/dev/null || true
            current_mirrors=999  # Force reflector to run
        fi
    fi

    # Run reflector if needed (first run or corrupted mirrorlist)
    if [ "${current_mirrors}" -lt 10 ] 2>/dev/null || [ "${current_mirrors}" -gt 50 ] 2>/dev/null; then
        preop "Filtering mirrors with reflector (HTTPS, latest 20, sorted by speed)..."
        if command -v reflector >/dev/null 2>&1; then
            # Backup original full mirrorlist before filtering (only if not already backed up)
            if [ ! -f /etc/pacman.d/mirrorlist.original ]; then
                cp /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist.original 2>/dev/null || true
            fi

            # Run reflector to get fast HTTPS mirrors
            reflector --protocol https --latest 20 --sort rate --save /etc/pacman.d/mirrorlist 2>/dev/null && \
                postop "Reflector filtered to $(grep -c '^Server = ' /etc/pacman.d/mirrorlist) fast mirrors" || \
                postop "Reflector failed, using original mirrorlist"
        else
            postop "Reflector not found, using default mirrorlist"
        fi
    fi
else # Always check full deps when not running with ISO
   	preop "Running from live system. Checking deps..."
    chmod +x "$SCRIPT_DIR/altodeps"
   	"$SCRIPT_DIR/altodeps"
    preop "Dependency check complete. Continuing..."
fi

# Clean up any stale pacman locks from previous cancelled installs
if [ -f /var/lib/pacman/db.lck ]; then
    preop "Removing stale pacman lock from previous session..."
    rm -f /var/lib/pacman/db.lck
fi

# Verify mirrorlist has valid servers before syncing
mirror_count="$(grep -c '^Server = ' /etc/pacman.d/mirrorlist 2>/dev/null || echo 0)"
if [ "${mirror_count}" -eq 0 ] 2>/dev/null; then
    postop "Mirrorlist is empty! Restoring from backup..."
    if [ -f /etc/pacman.d/mirrorlist.original ]; then
        cp /etc/pacman.d/mirrorlist.original /etc/pacman.d/mirrorlist
        postop "Restored $(grep -c '^Server = ' /etc/pacman.d/mirrorlist) mirrors from backup"
    else
        postop "ERROR: No backup mirrorlist found! Cannot proceed."
        exit 1
    fi
fi

# Sync package database before launching TUI to prevent hangs
preop "Syncing package database... & Checking up to date."
pacman -Sy --noconfirm && pacman -S --needed archlinux-keyring || postop "Database sync failed (continuing anyway)"

export PYTHONPATH="$SCRIPT_DIR:$PYTHONPATH"
python -B -m archinstall "$@"

#### OPTIONS from orignal arch install. Heavily simplified to be TUI based guided.
# All available archinstall command line options:
#
# -h, --help            show this help message and exit
# --live # --pandora    apply live install optimizations

####################### Could be super useful (ckbcomp and grub keymaps)
# --mountpoint [/mnt]   Define an alternate mount point for installation
# --skip-ntp            Disables NTP checks during installation
# --skip-wkd            Disables checking if archlinux keyring wkd sync is
#                       complete
# --skip-boot           Disables installation of a boot loader bad idea lol
# --no-pkg-lookups      Disabled package validation specifically prior to
#                       starting installation
# --offline             Disabled online upstream services such as package
#                       search and key-ring auto update
####################### Test fully local if possible see how fast it can be
# --verbose             Enabled verbose options
# --debug               Adds debug info into the log

# --config [CONFIG]     JSON configuration file
# --config-url [CONFIG_URL]
#                       Url to a JSON configuration file
# --creds [CREDS]       JSON credentials configuration file
# --creds-url [CREDS_URL]
#                       Url to a JSON credentials configuration file
# --creds-decryption-key [CREDS_DECRYPTION_KEY]
#                       Decryption key for credentials file
# --silent              WARNING: Disables all prompts for input and
#                       confirmation. If no configuration is provided, this is
#                       ignored
# --script [SCRIPT]     Script to run for installation ## Last line of installer

