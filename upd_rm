#!/bin/bash
. ./util_f
. ./...

latest_entry=$(tail -n 1 tests.status 2>/dev/null)

if [ -z "$latest_entry" ]; then
    echo "No entries found in tests.status"
    exit 1
fi

# Check if latest test passed or failed
if echo "$latest_entry" | grep -q "Status: OK"; then
    test_status="OK"
    kernel_color="darkgreen"
    tui_badge="Passing"
    tui_color="darkgreen"
elif echo "$latest_entry" | grep -q "Status: FAIL"; then
    test_status="FAIL"
    kernel_color="darkred"
    tui_badge="Failing"
    tui_color="darkred"
else
    echo "Unknown status in tests.status"
    exit 1
fi

# Check archlinux mirror status endpoint (just verify we get some JSON data)
mirror_url="https://archlinux.org/mirrors/status/json/"
ping_start=$(date +%s%3N)
# Fetch first bit of data, head will terminate curl early
response=$(timeout 15 curl -s "$mirror_url" 2>/dev/null | head -c 300)
if echo "$response" | grep -q "cutoff\|urls\|last_check"; then
    ping_end=$(date +%s%3N)
    ping_ms=$((ping_end - ping_start))
    mirror_status="online"
    mirror_badge="Online_%28${ping_ms}ms%29"
    mirror_color="darkgreen"
else
    mirror_status="offline"
    mirror_badge="Offline"
    mirror_color="darkred"
fi

test_date=$(echo "$latest_entry" | cut -d'|' -f1 | xargs)
version=$(echo "$latest_entry" | cut -d'|' -f2 | cut -d':' -f2 | xargs)
iso_name=$(echo "$latest_entry" | cut -d'|' -f3 | cut -d':' -f2 | xargs)
iso_size=$(echo "$latest_entry" | cut -d'|' -f4 | cut -d':' -f2 | xargs)

kernel_version=$(uname -r | cut -d'-' -f1)

sed -i '/<img src="\.\/vase\.svg"/d; /<table>/,/<\/table>/d; /<br clear="left">/d; /<strong>Version/d; /^<a href.*Releases/d; /^<br><br>$/d' README.md

awk -v version="$version" -v test_date="$test_date" -v iso_name="$iso_name" -v iso_size="$iso_size" -v kernel="$kernel_version" -v kernel_color="$kernel_color" -v mirror_badge="$mirror_badge" -v mirror_color="$mirror_color" -v tui_badge="$tui_badge" -v tui_color="$tui_color" '
/^# Vase$/ {
    print
    print ""
    print "<img src=\"./vase.svg\" alt=\"VaseLogo\" width=\"117\" align=\"left\">"
    print "<table>"
    print "    <tr>"
    print "        <td>"
    print "            <a href=\"https://github.com/h8d13/Vase/releases\">"
    print "                <img src=\"https://img.shields.io/badge/Arch_Linux-v" kernel "-" kernel_color "\" alt=\"Arch\">"
    print "            </a>"
    print "        </td>"
    print "    </tr>"
    print "    <tr>"
    print "        <td>"
    print "            <a href=\"https://status.archlinux.org/\">"
    print "                <img src=\"https://img.shields.io/badge/Mirror_Status-" mirror_badge "-" mirror_color "\" alt=\"MirrorStatus\">"
    print "            </a>"
    print "        </td>"
    print "    </tr>"
    print "    <tr>"
    print "        <td>"
    print "            <img src=\"https://img.shields.io/badge/TUI_Status-" tui_badge "-" tui_color "\" alt=\"TUIStatus\">"
    print "        </td>"
    print "    </tr>"
    print "</table>"
    print "<br clear=\"left\">"
    print ""
    print "<strong>Version:</strong> " version " | <strong>Tested:</strong> " test_date " | <strong>Size:</strong> " iso_size
    print "<br><br>"
    print "<a href=\"https://github.com/h8d13/Vase/releases\">Releases</a>"
    getline
    if ($0 != "") print
    next
}
{ print }
' README.md > README.md.tmp && mv README.md.tmp README.md

echo "README updated with latest release: ${version} (Kernel: ${kernel_version})"
