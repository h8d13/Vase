#!/bin/bash
. ./util_f
. ./...

latest_entry=$(tail -n 1 tests.status 2>/dev/null)

if [ -z "$latest_entry" ]; then
    echo "No entries found in tests.status"
    exit 1
fi

# Check if latest test passed or failed
if echo "$latest_entry" | grep -q "Status: OK"; then
    test_status="OK"
    kernel_color="darkgreen"
elif echo "$latest_entry" | grep -q "Status: FAIL"; then
    test_status="FAIL"
    kernel_color="darkred"
else
    echo "Unknown status in tests.status"
    exit 1
fi

# Ping archlinux mirror status endpoint (5 sec timeout like in installer)
mirror_url="https://archlinux.org/mirrors/status/json/"
ping_start=$(date +%s%3N)
if curl -s -m 5 --head "$mirror_url" >/dev/null 2>&1; then
    ping_end=$(date +%s%3N)
    ping_ms=$((ping_end - ping_start))
    mirror_status="online"
    mirror_color="darkgreen"
else
    ping_ms="N/A"
    mirror_status="offline"
    mirror_color="darkred"
fi

test_date=$(echo "$latest_entry" | cut -d'|' -f1 | xargs)
version=$(echo "$latest_entry" | cut -d'|' -f2 | cut -d':' -f2 | xargs)
iso_name=$(echo "$latest_entry" | cut -d'|' -f3 | cut -d':' -f2 | xargs)
iso_size=$(echo "$latest_entry" | cut -d'|' -f4 | cut -d':' -f2 | xargs)

kernel_version=$(uname -r | cut -d'-' -f1)

sed -i '/<div>/,/<\/div>/d' README.md

awk -v version="$version" -v test_date="$test_date" -v iso_name="$iso_name" -v iso_size="$iso_size" -v kernel="$kernel_version" -v kernel_color="$kernel_color" -v mirror_status="$mirror_status" -v mirror_color="$mirror_color" -v ping_ms="$ping_ms" '
/^# Vase$/ {
    print
    print ""
    print "<div>"
    print "    <img src=\"./vase.svg\" alt=\"VaseLogo\" width=\"72\">"
    print "    <a href=\"https://github.com/h8d13/Vase/releases\">"
    print "        <img src=\"https://img.shields.io/badge/Arch_Linux-v" kernel "-" kernel_color "\" alt=\"Arch\">"
    print "    </a>"
    print "    <br>"
    print "    <a href=\"https://archlinux.org/mirrors/status/\">"
    print "        <img src=\"https://img.shields.io/badge/Mirror_Status-" mirror_status "_%28" ping_ms "ms%29-" mirror_color "\" alt=\"MirrorStatus\">"
    print "    </a>"
    print "    <br><br>"
    print "    <strong>Version:</strong> " version " | <strong>Tested:</strong> " test_date " | <strong>Size:</strong> " iso_size
    print "    <br><br>"
    print "    <a href=\"https://github.com/h8d13/Vase/releases\">Releases</a>"
    print "</div>"
    getline
    if ($0 != "") print
    next
}
{ print }
' README.md > README.md.tmp && mv README.md.tmp README.md

echo "README updated with latest release: ${version} (Kernel: ${kernel_version})"
