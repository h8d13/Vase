#!/bin/bash
. ./util_f
. ./...

latest_entry=$(grep "Status: OK\|Status: FAIL" tests.status 2>/dev/null | tail -n 1)

if [ -z "$latest_entry" ]; then
    echo "No entries found in tests.status"
    exit 1
fi

# Check if latest test passed or failed
if echo "$latest_entry" | grep -q "Status: OK"; then
    test_status="OK"
    kernel_color="darkgreen"
    tui_badge="Passing"
    tui_color="darkgreen"
elif echo "$latest_entry" | grep -q "Status: FAIL"; then
    test_status="FAIL"
    kernel_color="darkred"
    tui_badge="Failing"
    tui_color="darkred"
else
    echo "Unknown status in tests.status"
    exit 1
fi

test_date=$(echo "$latest_entry" | cut -d'|' -f1 | xargs)
version=$(echo "$latest_entry" | cut -d'|' -f2 | cut -d':' -f2 | xargs)
iso_name=$(echo "$latest_entry" | cut -d'|' -f3 | cut -d':' -f2 | xargs)
iso_size=$(echo "$latest_entry" | cut -d'|' -f4 | cut -d':' -f2 | xargs)

kernel_version=$(uname -r | cut -d'-' -f1)

# Get KDE/Qt versions
plasma_ver=$(pacman -Q plasma-desktop 2>/dev/null | awk '{print $2}' | cut -d'-' -f1 || echo "N/A")
frameworks_ver=$(pacman -Q karchive 2>/dev/null | awk '{print $2}' | cut -d'-' -f1 || echo "N/A")
qt_ver=$(pacman -Q qt6-base 2>/dev/null | awk '{print $2}' | cut -d'-' -f1 || echo "N/A")
kde_info="Plasma: ${plasma_ver} | Frameworks: ${frameworks_ver} | Qt: ${qt_ver}"

# Log to tests.status
echo "$(date '+%Y-%m-%d %H:%M:%S') | Host KDE/Qt: ${kde_info}" >> tests.status
echo "Logged KDE/Qt versions: Plasma ${plasma_ver}, Frameworks ${frameworks_ver}, Qt ${qt_ver}"

# Update SVG badge files
sed -i "s/aria-label=\"Arch Linux: [^\"]*\"/aria-label=\"Arch Linux: v${kernel_version}\"/" .github/badges/arch-linux.svg
sed -i "s/>v[0-9.]*<\/text>/>v${kernel_version}<\/text>/g" .github/badges/arch-linux.svg

sed -i "s/aria-label=\"Plasma: [^\"]*\"/aria-label=\"Plasma: ${plasma_ver}\"/" .github/badges/plasma.svg
sed -i "s/>[0-9.]*<\/text>/>${plasma_ver}<\/text>/g" .github/badges/plasma.svg

sed -i "s/aria-label=\"TUI Status: [^\"]*\"/aria-label=\"TUI Status: ${tui_badge}\"/" .github/badges/tui-status.svg
sed -i "s/>Passing<\/text>/>${tui_badge}<\/text>/g" .github/badges/tui-status.svg
sed -i "s/>Failing<\/text>/>${tui_badge}<\/text>/g" .github/badges/tui-status.svg

sed -i "s/aria-label=\"Qt: [^\"]*\"/aria-label=\"Qt: ${qt_ver}\"/" .github/badges/qt.svg
sed -i "s/>[0-9.]*<\/text>/>${qt_ver}<\/text>/g" .github/badges/qt.svg

sed -i "s/aria-label=\"Fws: [^\"]*\"/aria-label=\"Fws: ${frameworks_ver}\"/" .github/badges/frameworks.svg
sed -i "s/>[0-9.]*<\/text>/>${frameworks_ver}<\/text>/g" .github/badges/frameworks.svg

# Update README version info only
sed -i "s/<strong>Version:<\/strong> [^|]*/<strong>Version:<\/strong> ${version}/" README.md
sed -i "s/<strong>Tested:<\/strong> [^|]*/<strong>Tested:<\/strong> ${test_date}/" README.md
sed -i "s/<strong>Size:<\/strong> [^<]*/<strong>Size:<\/strong> ${iso_size}/" README.md

echo "README and badges updated with latest release: ${version} (Kernel: ${kernel_version})"
