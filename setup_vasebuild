#!/bin/bash

. ./util_f
. ./...

if file_ex "${rel}${p_lib}/${rcw_file}"; then
    . "${rel}${p_lib}/${rcw_file}"
fi

# Check if running as root
if ! im_groot; then
    die "This script must be run as root or with sudo"
fi

USERNAME="vasebuild"

# GPG key configuration (customize these)
GPG_NAME="${GPG_NAME:-Vase Build}"
GPG_EMAIL="${GPG_EMAIL:-vasebuild@localhost}"
GPG_EXPIRE="${GPG_EXPIRE:-0}"
#  - 0 = never expires
#  - 1d = 1 day
#  - 1w = 1 week
#  - 1m = 1 month
#  - 1y = 1 year

info "GPG Key Configuration:"
info "  Name: $GPG_NAME"
info "  Email: $GPG_EMAIL"
info "  Expiration: $GPG_EXPIRE (0 = never)"
echo ""
read -p "Continue with these settings? (Y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Nn]$ ]]; then
    die "Setup cancelled. Set GPG_NAME, GPG_EMAIL, GPG_EXPIRE environment variables and re-run."
fi

# Check if user already exists
if id "$USERNAME" &>/dev/null; then
    warn "User $USERNAME already exists"
    read -p "Delete and recreate? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        info "Removing existing user..."
        userdel -r "$USERNAME" 2>/dev/null || true
    else
        die "User setup cancelled"
    fi
fi

info "Creating user: $USERNAME"
useradd -m -G wheel -s /bin/bash "$USERNAME"

info "Setting password for $USERNAME"
passwd "$USERNAME"

# Ensure wheel group has sudo access
if ! grep -q "^%wheel ALL=(ALL:ALL) ALL" /etc/sudoers; then
    info "Enabling sudo for wheel group"
    echo "%wheel ALL=(ALL:ALL) ALL" >> /etc/sudoers
fi

info "Generating GPG key for $USERNAME"
su - "$USERNAME" -c "gpg --batch --full-generate-key <<EOF
%no-protection
Key-Type: RSA
Key-Length: 4096
Name-Real: $GPG_NAME
Name-Email: $GPG_EMAIL
Expire-Date: $GPG_EXPIRE
EOF"

# Get the GPG public key fingerprint (safe to share)
GPG_FINGERPRINT=$(su - "$USERNAME" -c "gpg --list-keys --fingerprint --with-colons | grep fpr | head -1 | cut -d':' -f10")

if [ -n "$GPG_FINGERPRINT" ]; then
    reop "GPG key created successfully"
    info "Public key fingerprint: $GPG_FINGERPRINT"
else
    warn "Failed to retrieve GPG key fingerprint"
fi

reop "User $USERNAME created successfully with sudo and GPG key"
info "You can now use: sudo -u $USERNAME ./main -a /dev/sdX"
info "Or login to the user normally and use it from there...."
